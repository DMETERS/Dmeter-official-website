---
// Dmetercito - Chatbot de flujo guiado
// 100% vanilla JS, sin dependencias, envÃ­a a Netlify Forms
import { type Lang, defaultLang } from '../i18n/utils';

interface Props {
  lang?: Lang;
}

const { lang = defaultLang } = Astro.props;

// Textos por idioma
const texts = {
  es: {
    assistant: 'Tu asistente digital',
    placeholder: 'Escribe aquÃ­...',
    send: 'Enviar',
    close: 'Cerrar chat',
    tree: {
      INICIO: {
        message: 'Â¡Hola! Soy Dmetercito ðŸŒ± Â¿En quÃ© puedo ayudarte?',
        options: [
          { text: 'Necesito un proyecto', next: 'TIPO_PROYECTO' },
          { text: 'Tengo una duda', next: 'FAQ' },
          { text: 'Solo exploro', next: 'DESPEDIDA_EXPLORA' }
        ]
      },
      TIPO_PROYECTO: {
        message: 'Â¡Genial! Â¿QuÃ© tipo de proyecto necesitas?',
        options: [
          { text: 'Landing Page', next: 'DETALLES_LANDING', save: { tipo_proyecto: 'Landing Page' } },
          { text: 'Software a medida', next: 'DETALLES_SOFTWARE', save: { tipo_proyecto: 'Software a medida' } },
          { text: 'Dashboard', next: 'URGENCIA', save: { tipo_proyecto: 'Dashboard' } },
          { text: 'SoluciÃ³n con IA', next: 'URGENCIA', save: { tipo_proyecto: 'SoluciÃ³n con IA' } },
          { text: 'IntegraciÃ³n/API', next: 'URGENCIA', save: { tipo_proyecto: 'IntegraciÃ³n/API' } },
          { text: 'No estoy seguro', next: 'DETALLES_GENERAL', save: { tipo_proyecto: 'Por definir' } }
        ]
      },
      DETALLES_LANDING: {
        message: 'Â¿Ya tienes el diseÃ±o o necesitas que lo creemos tambiÃ©n?',
        options: [
          { text: 'Ya tengo diseÃ±o', next: 'URGENCIA', save: { detalles: 'Tiene diseÃ±o propio' } },
          { text: 'Necesito diseÃ±o', next: 'URGENCIA', save: { detalles: 'Necesita diseÃ±o' } }
        ]
      },
      DETALLES_SOFTWARE: {
        message: 'Â¿El software es para uso interno de tu empresa o para tus clientes?',
        options: [
          { text: 'Uso interno', next: 'URGENCIA', save: { detalles: 'Uso interno' } },
          { text: 'Para mis clientes', next: 'URGENCIA', save: { detalles: 'Para clientes externos' } }
        ]
      },
      DETALLES_GENERAL: {
        message: 'Â¿Puedes contarme brevemente quÃ© necesitas?',
        input: true,
        inputType: 'text',
        placeholder: 'Describe tu proyecto...',
        next: 'URGENCIA',
        saveField: 'detalles'
      },
      URGENCIA: {
        message: 'Â¿Para cuÃ¡ndo lo necesitas?',
        options: [
          { text: 'Lo antes posible', next: 'CONTACTO', save: { urgencia: 'Urgente' } },
          { text: '1-2 meses', next: 'CONTACTO', save: { urgencia: '1-2 meses' } },
          { text: '3+ meses', next: 'CONTACTO', save: { urgencia: '3+ meses' } },
          { text: 'Solo explorando', next: 'CONTACTO', save: { urgencia: 'Sin fecha definida' } }
        ]
      },
      CONTACTO: {
        message: 'Â¡Perfecto! Â¿CÃ³mo te llamas?',
        input: true,
        inputType: 'text',
        placeholder: 'Tu nombre...',
        next: 'EMAIL',
        saveField: 'nombre'
      },
      EMAIL: {
        message: 'Â¡Encantado, {nombre}! Â¿CuÃ¡l es tu email para contactarte?',
        input: true,
        inputType: 'email',
        placeholder: 'tu@email.com',
        next: 'FINAL',
        saveField: 'email'
      },
      FINAL: {
        message: 'Â¡Listo! Te contactaremos pronto a {email}',
        options: [
          { text: 'ðŸ“¤ Enviar consulta', next: 'ENVIADO', action: 'submit' }
        ]
      },
      ENVIADO: {
        message: 'Â¡Gracias por confiar en Dmeter! ðŸŒ± Te responderemos en menos de 24 horas.',
        options: [
          { text: 'Cerrar chat', next: 'CLOSE' }
        ]
      },
      FAQ: {
        message: 'Â¿Sobre quÃ© tienes dudas?',
        options: [
          { text: 'Precios', next: 'FAQ_PRECIOS' },
          { text: 'Tiempos', next: 'FAQ_TIEMPOS' },
          { text: 'TecnologÃ­as', next: 'FAQ_TECH' },
          { text: 'Otra cosa', next: 'CONTACTO' }
        ]
      },
      FAQ_PRECIOS: {
        message: 'Cada proyecto es Ãºnico, por eso no manejamos precios fijos. CuÃ©ntanos tu idea y te damos un presupuesto sin compromiso.',
        options: [
          { text: 'Quiero cotizar', next: 'TIPO_PROYECTO' },
          { text: 'Tengo otra duda', next: 'FAQ' }
        ]
      },
      FAQ_TIEMPOS: {
        message: 'Depende de la complejidad: una landing page 1-2 semanas, software a medida 1-3 meses. Â¡Pero siempre cumplimos!',
        options: [
          { text: 'Quiero cotizar', next: 'TIPO_PROYECTO' },
          { text: 'Tengo otra duda', next: 'FAQ' }
        ]
      },
      FAQ_TECH: {
        message: 'Usamos las mejores herramientas para cada caso: React, Node, Python, IA... No te preocupes por eso, nosotros elegimos lo mejor para ti.',
        options: [
          { text: 'Quiero cotizar', next: 'TIPO_PROYECTO' },
          { text: 'Tengo otra duda', next: 'FAQ' }
        ]
      },
      DESPEDIDA_EXPLORA: {
        message: 'Â¡Sin problema! Navega tranquilo por el sitio. Si necesitas algo, aquÃ­ estarÃ© ðŸŒ±',
        options: [
          { text: 'Cerrar chat', next: 'CLOSE' }
        ]
      },
      ERROR: {
        message: 'Hubo un error al enviar. Por favor intenta de nuevo o escrÃ­benos a hola@dmeter.dev'
      }
    }
  },
  en: {
    assistant: 'Your digital assistant',
    placeholder: 'Type here...',
    send: 'Send',
    close: 'Close chat',
    tree: {
      INICIO: {
        message: "Hi! I'm Dmetercito ðŸŒ± How can I help you?",
        options: [
          { text: 'I need a project', next: 'TIPO_PROYECTO' },
          { text: 'I have a question', next: 'FAQ' },
          { text: 'Just browsing', next: 'DESPEDIDA_EXPLORA' }
        ]
      },
      TIPO_PROYECTO: {
        message: 'Great! What type of project do you need?',
        options: [
          { text: 'Landing Page', next: 'DETALLES_LANDING', save: { tipo_proyecto: 'Landing Page' } },
          { text: 'Custom Software', next: 'DETALLES_SOFTWARE', save: { tipo_proyecto: 'Custom Software' } },
          { text: 'Dashboard', next: 'URGENCIA', save: { tipo_proyecto: 'Dashboard' } },
          { text: 'AI Solution', next: 'URGENCIA', save: { tipo_proyecto: 'AI Solution' } },
          { text: 'Integration/API', next: 'URGENCIA', save: { tipo_proyecto: 'Integration/API' } },
          { text: 'Not sure yet', next: 'DETALLES_GENERAL', save: { tipo_proyecto: 'To be defined' } }
        ]
      },
      DETALLES_LANDING: {
        message: 'Do you already have a design or do you need us to create it?',
        options: [
          { text: 'I have a design', next: 'URGENCIA', save: { detalles: 'Has own design' } },
          { text: 'I need design', next: 'URGENCIA', save: { detalles: 'Needs design' } }
        ]
      },
      DETALLES_SOFTWARE: {
        message: 'Is the software for internal use or for your customers?',
        options: [
          { text: 'Internal use', next: 'URGENCIA', save: { detalles: 'Internal use' } },
          { text: 'For my customers', next: 'URGENCIA', save: { detalles: 'For external clients' } }
        ]
      },
      DETALLES_GENERAL: {
        message: 'Can you briefly tell me what you need?',
        input: true,
        inputType: 'text',
        placeholder: 'Describe your project...',
        next: 'URGENCIA',
        saveField: 'detalles'
      },
      URGENCIA: {
        message: 'When do you need it?',
        options: [
          { text: 'ASAP', next: 'CONTACTO', save: { urgencia: 'Urgent' } },
          { text: '1-2 months', next: 'CONTACTO', save: { urgencia: '1-2 months' } },
          { text: '3+ months', next: 'CONTACTO', save: { urgencia: '3+ months' } },
          { text: 'Just exploring', next: 'CONTACTO', save: { urgencia: 'No deadline' } }
        ]
      },
      CONTACTO: {
        message: "Perfect! What's your name?",
        input: true,
        inputType: 'text',
        placeholder: 'Your name...',
        next: 'EMAIL',
        saveField: 'nombre'
      },
      EMAIL: {
        message: "Nice to meet you, {nombre}! What's your email?",
        input: true,
        inputType: 'email',
        placeholder: 'your@email.com',
        next: 'FINAL',
        saveField: 'email'
      },
      FINAL: {
        message: "All set! We'll contact you at {email}",
        options: [
          { text: 'ðŸ“¤ Send inquiry', next: 'ENVIADO', action: 'submit' }
        ]
      },
      ENVIADO: {
        message: "Thanks for trusting Dmeter! ðŸŒ± We'll respond within 24 hours.",
        options: [
          { text: 'Close chat', next: 'CLOSE' }
        ]
      },
      FAQ: {
        message: 'What would you like to know?',
        options: [
          { text: 'Pricing', next: 'FAQ_PRECIOS' },
          { text: 'Timelines', next: 'FAQ_TIEMPOS' },
          { text: 'Technologies', next: 'FAQ_TECH' },
          { text: 'Something else', next: 'CONTACTO' }
        ]
      },
      FAQ_PRECIOS: {
        message: "Every project is unique, so we don't have fixed prices. Tell us your idea and we'll give you a free quote.",
        options: [
          { text: 'Get a quote', next: 'TIPO_PROYECTO' },
          { text: 'Another question', next: 'FAQ' }
        ]
      },
      FAQ_TIEMPOS: {
        message: 'It depends on complexity: a landing page takes 1-2 weeks, custom software 1-3 months. But we always deliver!',
        options: [
          { text: 'Get a quote', next: 'TIPO_PROYECTO' },
          { text: 'Another question', next: 'FAQ' }
        ]
      },
      FAQ_TECH: {
        message: "We use the best tools for each case: React, Node, Python, AI... Don't worry about that, we choose what's best for you.",
        options: [
          { text: 'Get a quote', next: 'TIPO_PROYECTO' },
          { text: 'Another question', next: 'FAQ' }
        ]
      },
      DESPEDIDA_EXPLORA: {
        message: "No problem! Browse around. If you need anything, I'll be here ðŸŒ±",
        options: [
          { text: 'Close chat', next: 'CLOSE' }
        ]
      },
      ERROR: {
        message: 'There was an error sending. Please try again or email us at hola@dmeter.dev'
      }
    }
  },
  'pt-br': {
    assistant: 'Seu assistente digital',
    placeholder: 'Digite aqui...',
    send: 'Enviar',
    close: 'Fechar chat',
    tree: {
      INICIO: {
        message: 'OlÃ¡! Sou o Dmetercito ðŸŒ± Como posso ajudar?',
        options: [
          { text: 'Preciso de um projeto', next: 'TIPO_PROYECTO' },
          { text: 'Tenho uma dÃºvida', next: 'FAQ' },
          { text: 'SÃ³ explorando', next: 'DESPEDIDA_EXPLORA' }
        ]
      },
      TIPO_PROYECTO: {
        message: 'Ã“timo! Que tipo de projeto vocÃª precisa?',
        options: [
          { text: 'Landing Page', next: 'DETALLES_LANDING', save: { tipo_proyecto: 'Landing Page' } },
          { text: 'Software sob medida', next: 'DETALLES_SOFTWARE', save: { tipo_proyecto: 'Software sob medida' } },
          { text: 'Dashboard', next: 'URGENCIA', save: { tipo_proyecto: 'Dashboard' } },
          { text: 'SoluÃ§Ã£o com IA', next: 'URGENCIA', save: { tipo_proyecto: 'SoluÃ§Ã£o com IA' } },
          { text: 'IntegraÃ§Ã£o/API', next: 'URGENCIA', save: { tipo_proyecto: 'IntegraÃ§Ã£o/API' } },
          { text: 'NÃ£o tenho certeza', next: 'DETALLES_GENERAL', save: { tipo_proyecto: 'A definir' } }
        ]
      },
      DETALLES_LANDING: {
        message: 'VocÃª jÃ¡ tem o design ou precisa que criemos tambÃ©m?',
        options: [
          { text: 'JÃ¡ tenho design', next: 'URGENCIA', save: { detalles: 'Tem design prÃ³prio' } },
          { text: 'Preciso de design', next: 'URGENCIA', save: { detalles: 'Precisa de design' } }
        ]
      },
      DETALLES_SOFTWARE: {
        message: 'O software Ã© para uso interno da sua empresa ou para seus clientes?',
        options: [
          { text: 'Uso interno', next: 'URGENCIA', save: { detalles: 'Uso interno' } },
          { text: 'Para meus clientes', next: 'URGENCIA', save: { detalles: 'Para clientes externos' } }
        ]
      },
      DETALLES_GENERAL: {
        message: 'Pode me contar brevemente o que vocÃª precisa?',
        input: true,
        inputType: 'text',
        placeholder: 'Descreva seu projeto...',
        next: 'URGENCIA',
        saveField: 'detalles'
      },
      URGENCIA: {
        message: 'Para quando vocÃª precisa?',
        options: [
          { text: 'O mais rÃ¡pido possÃ­vel', next: 'CONTACTO', save: { urgencia: 'Urgente' } },
          { text: '1-2 meses', next: 'CONTACTO', save: { urgencia: '1-2 meses' } },
          { text: '3+ meses', next: 'CONTACTO', save: { urgencia: '3+ meses' } },
          { text: 'SÃ³ explorando', next: 'CONTACTO', save: { urgencia: 'Sem prazo definido' } }
        ]
      },
      CONTACTO: {
        message: 'Perfeito! Qual Ã© o seu nome?',
        input: true,
        inputType: 'text',
        placeholder: 'Seu nome...',
        next: 'EMAIL',
        saveField: 'nombre'
      },
      EMAIL: {
        message: 'Prazer, {nombre}! Qual Ã© o seu email para entrarmos em contato?',
        input: true,
        inputType: 'email',
        placeholder: 'seu@email.com',
        next: 'FINAL',
        saveField: 'email'
      },
      FINAL: {
        message: 'Pronto! Entraremos em contato em {email}',
        options: [
          { text: 'ðŸ“¤ Enviar consulta', next: 'ENVIADO', action: 'submit' }
        ]
      },
      ENVIADO: {
        message: 'Obrigado por confiar na Dmeter! ðŸŒ± Responderemos em atÃ© 24 horas.',
        options: [
          { text: 'Fechar chat', next: 'CLOSE' }
        ]
      },
      FAQ: {
        message: 'Sobre o que vocÃª tem dÃºvidas?',
        options: [
          { text: 'PreÃ§os', next: 'FAQ_PRECIOS' },
          { text: 'Prazos', next: 'FAQ_TIEMPOS' },
          { text: 'Tecnologias', next: 'FAQ_TECH' },
          { text: 'Outra coisa', next: 'CONTACTO' }
        ]
      },
      FAQ_PRECIOS: {
        message: 'Cada projeto Ã© Ãºnico, por isso nÃ£o temos preÃ§os fixos. Conte sua ideia e daremos um orÃ§amento sem compromisso.',
        options: [
          { text: 'Quero orÃ§amento', next: 'TIPO_PROYECTO' },
          { text: 'Outra dÃºvida', next: 'FAQ' }
        ]
      },
      FAQ_TIEMPOS: {
        message: 'Depende da complexidade: uma landing page leva 1-2 semanas, software sob medida 1-3 meses. Mas sempre cumprimos!',
        options: [
          { text: 'Quero orÃ§amento', next: 'TIPO_PROYECTO' },
          { text: 'Outra dÃºvida', next: 'FAQ' }
        ]
      },
      FAQ_TECH: {
        message: 'Usamos as melhores ferramentas para cada caso: React, Node, Python, IA... NÃ£o se preocupe com isso, escolhemos o melhor para vocÃª.',
        options: [
          { text: 'Quero orÃ§amento', next: 'TIPO_PROYECTO' },
          { text: 'Outra dÃºvida', next: 'FAQ' }
        ]
      },
      DESPEDIDA_EXPLORA: {
        message: 'Sem problema! Navegue tranquilo pelo site. Se precisar de algo, estarei aqui ðŸŒ±',
        options: [
          { text: 'Fechar chat', next: 'CLOSE' }
        ]
      },
      ERROR: {
        message: 'Houve um erro ao enviar. Por favor tente novamente ou escreva para hola@dmeter.dev'
      }
    }
  }
};

const t = texts[lang] || texts.es;
const treeJson = JSON.stringify(t.tree);
---

<!-- BotÃ³n flotante -->
<button
  id="dmetercito-toggle"
  class="fixed bottom-6 right-6 z-50 w-14 h-14 rounded-full flex items-center justify-center shadow-lg hover:scale-110 transition-all duration-300 gradient-solarpunk group"
  aria-label="Abrir asistente Dmetercito"
>
  <!-- Icono de chat con hoja -->
  <svg class="w-7 h-7 text-white" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
    <!-- Burbuja de chat -->
    <path d="M21 11.5a8.38 8.38 0 01-.9 3.8 8.5 8.5 0 01-7.6 4.7 8.38 8.38 0 01-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 01-.9-3.8 8.5 8.5 0 014.7-7.6 8.38 8.38 0 013.8-.9h.5a8.48 8.48 0 018 8v.5z" fill="currentColor" opacity="0.2" stroke="currentColor"/>
    <!-- Hojita decorativa -->
    <path d="M16 4c0 0-2 1-2 3s2 3 2 3c0 0 2-1 2-3s-2-3-2-3z" fill="#34D399" stroke="#34D399" stroke-width="0.5"/>
  </svg>
  <!-- Indicador de pulso -->
  <span class="absolute -top-1 -right-1 w-4 h-4 bg-accent-solar rounded-full animate-ping"></span>
  <span class="absolute -top-1 -right-1 w-4 h-4 bg-accent-solar rounded-full"></span>
</button>

<!-- Panel del chat -->
<div
  id="dmetercito-panel"
  class="fixed bottom-24 right-6 z-50 w-80 sm:w-96 max-h-[500px] rounded-2xl overflow-hidden shadow-2xl opacity-0 scale-95 pointer-events-none transition-all duration-300"
  style="background: rgba(26, 61, 46, 0.95); backdrop-filter: blur(20px); border: 1px solid rgba(16, 185, 129, 0.2);"
>
  <!-- Header -->
  <div class="bg-gradient-to-r from-primary/20 to-accent-cyan/20 px-4 py-3 flex items-center justify-between border-b border-primary/20">
    <div class="flex items-center gap-3">
      <div class="w-10 h-10 rounded-full gradient-solarpunk flex items-center justify-center">
        <svg class="w-5 h-5 text-white" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
          <path d="M21 11.5a8.38 8.38 0 01-.9 3.8 8.5 8.5 0 01-7.6 4.7 8.38 8.38 0 01-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 01-.9-3.8 8.5 8.5 0 014.7-7.6 8.38 8.38 0 013.8-.9h.5a8.48 8.48 0 018 8v.5z" fill="currentColor" opacity="0.3"/>
          <path d="M16 4c0 0-2 1-2 3s2 3 2 3c0 0 2-1 2-3s-2-3-2-3z" fill="#34D399"/>
        </svg>
      </div>
      <div>
        <span class="font-semibold text-text-light">Dmetercito</span>
        <span class="block text-xs text-primary">{t.assistant}</span>
      </div>
    </div>
    <button id="dmetercito-close" class="text-text-muted hover:text-text-light transition-colors p-1">
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
      </svg>
    </button>
  </div>

  <!-- Mensajes -->
  <div id="dmetercito-messages" class="p-4 overflow-y-auto" style="height: 320px;">
  </div>

  <!-- Input area -->
  <div id="dmetercito-input-area" class="hidden px-4 py-3 border-t border-primary/20">
    <form id="dmetercito-input-form" class="flex gap-2">
      <input
        type="text"
        id="dmetercito-input"
        class="flex-1 px-4 py-2 bg-bg-dark border border-primary/20 rounded-xl text-text-light text-sm focus:outline-none focus:border-primary"
        placeholder={t.placeholder}
      />
      <button
        type="submit"
        class="px-4 py-2 gradient-solarpunk rounded-xl text-white text-sm font-medium hover:opacity-90 transition-opacity"
      >
        {t.send}
      </button>
    </form>
  </div>
</div>

<!-- Form oculto para Netlify -->
<form id="dmetercito-form" name="dmetercito" method="POST" data-netlify="true" netlify-honeypot="bot-field" class="hidden">
  <input type="hidden" name="form-name" value="dmetercito" />
  <input type="hidden" name="bot-field" />
  <input type="hidden" name="idioma" value={lang} />
  <input type="hidden" name="tipo_proyecto" id="form-tipo" />
  <input type="hidden" name="detalles" id="form-detalles" />
  <input type="hidden" name="urgencia" id="form-urgencia" />
  <input type="hidden" name="nombre" id="form-nombre" />
  <input type="hidden" name="email" id="form-email" />
  <input type="hidden" name="flujo_completo" id="form-flujo" />
</form>

<script define:vars={{ treeJson }}>
  const tree = JSON.parse(treeJson);

  const state = {
    isOpen: false,
    currentStep: 'INICIO',
    data: {
      tipo_proyecto: '',
      detalles: '',
      urgencia: '',
      nombre: '',
      email: ''
    },
    history: []
  };

  const toggle = document.getElementById('dmetercito-toggle');
  const panel = document.getElementById('dmetercito-panel');
  const closeBtn = document.getElementById('dmetercito-close');
  const messagesContainer = document.getElementById('dmetercito-messages');
  const inputArea = document.getElementById('dmetercito-input-area');
  const inputForm = document.getElementById('dmetercito-input-form');
  const input = document.getElementById('dmetercito-input');
  const netlifyForm = document.getElementById('dmetercito-form');

  function openChat() {
    state.isOpen = true;
    panel.classList.remove('opacity-0', 'scale-95', 'pointer-events-none');
    panel.classList.add('opacity-100', 'scale-100');
    toggle.querySelector('.animate-ping')?.classList.add('hidden');
    if (messagesContainer.children.length === 0) {
      showStep('INICIO');
    }
  }

  function closeChat() {
    state.isOpen = false;
    panel.classList.add('opacity-0', 'scale-95', 'pointer-events-none');
    panel.classList.remove('opacity-100', 'scale-100');
  }

  function addMessage(text, isBot = true) {
    const msg = document.createElement('div');
    msg.className = `flex ${isBot ? 'justify-start' : 'justify-end'} mb-3 animate-fade-in`;
    const bubble = document.createElement('div');
    bubble.className = isBot
      ? 'bg-primary/20 text-text-light rounded-2xl rounded-bl-md px-4 py-2 max-w-[85%] text-sm'
      : 'bg-accent-cyan/20 text-text-light rounded-2xl rounded-br-md px-4 py-2 max-w-[85%] text-sm';
    bubble.textContent = text;
    msg.appendChild(bubble);
    messagesContainer.appendChild(msg);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
  }

  function addTypingIndicator() {
    const typing = document.createElement('div');
    typing.id = 'typing-indicator';
    typing.className = 'flex justify-start mb-3';
    typing.innerHTML = `
      <div class="bg-primary/20 rounded-2xl rounded-bl-md px-4 py-3 flex gap-1">
        <span class="w-2 h-2 bg-primary rounded-full animate-bounce" style="animation-delay: 0ms"></span>
        <span class="w-2 h-2 bg-primary rounded-full animate-bounce" style="animation-delay: 150ms"></span>
        <span class="w-2 h-2 bg-primary rounded-full animate-bounce" style="animation-delay: 300ms"></span>
      </div>
    `;
    messagesContainer.appendChild(typing);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
  }

  function removeTypingIndicator() {
    document.getElementById('typing-indicator')?.remove();
  }

  function addOptions(options) {
    const container = document.createElement('div');
    container.className = 'flex flex-wrap gap-2 mb-3 animate-fade-in';
    options.forEach(opt => {
      const btn = document.createElement('button');
      btn.className = 'px-3 py-2 bg-bg-dark/50 border border-primary/30 rounded-xl text-sm text-text-light hover:bg-primary/20 hover:border-primary transition-all';
      btn.textContent = opt.text;
      btn.onclick = () => handleOption(opt);
      container.appendChild(btn);
    });
    messagesContainer.appendChild(container);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
  }

  function showStep(stepName) {
    const step = tree[stepName];
    if (!step) return;

    state.currentStep = stepName;
    state.history.push(stepName);

    messagesContainer.querySelectorAll('.flex.flex-wrap').forEach(el => el.remove());
    addTypingIndicator();

    setTimeout(() => {
      removeTypingIndicator();

      let message = step.message;
      message = message.replace('{nombre}', state.data.nombre || '');
      message = message.replace('{email}', state.data.email || '');
      addMessage(message);

      if (step.input) {
        inputArea.classList.remove('hidden');
        input.type = step.inputType || 'text';
        input.placeholder = step.placeholder || '';
        input.value = '';
        input.focus();
        inputForm.dataset.currentStep = stepName;
      } else {
        inputArea.classList.add('hidden');
      }

      if (step.options) {
        setTimeout(() => addOptions(step.options), 300);
      }
    }, 600);
  }

  function handleOption(option) {
    addMessage(option.text, false);
    if (option.save) {
      Object.assign(state.data, option.save);
    }
    if (option.action === 'submit') {
      submitForm();
      return;
    }
    if (option.next === 'CLOSE') {
      setTimeout(closeChat, 500);
    } else {
      setTimeout(() => showStep(option.next), 300);
    }
  }

  function handleInputSubmit(e) {
    e.preventDefault();
    const value = input.value.trim();
    if (!value) return;

    const currentStep = tree[inputForm.dataset.currentStep];
    if (!currentStep) return;

    addMessage(value, false);
    if (currentStep.saveField) {
      state.data[currentStep.saveField] = value;
    }
    inputArea.classList.add('hidden');
    input.value = '';
    setTimeout(() => showStep(currentStep.next), 300);
  }

  function submitForm() {
    document.getElementById('form-tipo').value = state.data.tipo_proyecto || '';
    document.getElementById('form-detalles').value = state.data.detalles || '';
    document.getElementById('form-urgencia').value = state.data.urgencia || '';
    document.getElementById('form-nombre').value = state.data.nombre || '';
    document.getElementById('form-email').value = state.data.email || '';
    document.getElementById('form-flujo').value = JSON.stringify(state.history);

    const formData = new FormData(netlifyForm);

    fetch('/', {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      body: new URLSearchParams(formData).toString()
    })
    .then(() => showStep('ENVIADO'))
    .catch(() => addMessage(tree.ERROR?.message || 'Error'));
  }

  toggle.addEventListener('click', () => state.isOpen ? closeChat() : openChat());
  closeBtn.addEventListener('click', closeChat);
  inputForm.addEventListener('submit', handleInputSubmit);
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && state.isOpen) closeChat();
  });
</script>

<style>
  @keyframes fade-in {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }
  .animate-fade-in {
    animation: fade-in 0.3s ease-out forwards;
  }
  #dmetercito-messages::-webkit-scrollbar {
    width: 4px;
  }
  #dmetercito-messages::-webkit-scrollbar-track {
    background: transparent;
  }
  #dmetercito-messages::-webkit-scrollbar-thumb {
    background: rgba(16, 185, 129, 0.3);
    border-radius: 4px;
  }
</style>
